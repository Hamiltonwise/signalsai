/**
 * Admin Organizations API
 *
 * Typed functions for admin organization management endpoints.
 * All functions use apiGet/apiPatch/apiDelete which internally call getPriorityItem
 * for auth tokens, making them pilot-mode-aware.
 */

import { apiGet, apiPatch, apiDelete, apiPost } from "./index";

/**
 * Typed interfaces for admin org responses
 */

export interface AdminOrganization {
  id: number;
  name: string;
  domain: string | null;
  subscription_tier: "DWY" | "DFY" | null;
  subscription_status: string | null;
  stripe_customer_id: string | null;
  created_at: string;
  userCount: number;
  connections: { gbp: boolean };
}

export interface AdminUser {
  id: number;
  name: string;
  email: string;
  role: string;
  joined_at: string;
  has_password: boolean;
}

export interface AdminConnection {
  accountId: string;
  email: string;
  properties: { gbp?: any[] };
}

export interface AdminWebsite {
  id: number;
  generated_hostname: string;
  status: string;
  created_at: string;
}

export interface AdminOrganizationDetail {
  id: number;
  name: string;
  domain: string | null;
  subscription_tier: "DWY" | "DFY" | null;
  subscription_status: string | null;
  stripe_customer_id: string | null;
  created_at: string;
  userCount?: number;
  users: AdminUser[];
  connections: AdminConnection[];
  website: AdminWebsite | null;
}

export interface AdminGoogleProperty {
  id: number;
  location_id: number;
  type: "gbp";
  external_id: string;
  display_name: string | null;
  metadata: Record<string, unknown> | null;
  selected: boolean;
  created_at: string;
  updated_at: string;
}

export interface AdminLocation {
  id: number;
  organization_id: number;
  name: string;
  domain: string | null;
  is_primary: boolean;
  created_at: string;
  updated_at: string;
  googleProperties: AdminGoogleProperty[];
}

export interface AdminLocationsResponse {
  success: boolean;
  locations: AdminLocation[];
  total: number;
}

export interface AdminOrganizationsListResponse {
  success: boolean;
  organizations: AdminOrganization[];
}

export interface AdminOrganizationDetailResponse {
  success: boolean;
  organization: AdminOrganizationDetail;
  users: AdminUser[];
  connections: AdminConnection[];
  website: AdminWebsite | null;
}

export interface PilotSessionResponse {
  success: boolean;
  token: string;
  googleAccountId: number;
  user: { id: number; email: string };
}

/**
 * List all organizations with summary metadata
 */
export async function adminListOrganizations(): Promise<AdminOrganizationsListResponse> {
  return apiGet({ path: "/admin/organizations" });
}

/**
 * Get a single organization with users, connections, and website details
 */
export async function adminGetOrganization(
  orgId: number
): Promise<AdminOrganizationDetailResponse> {
  return apiGet({ path: `/admin/organizations/${orgId}` });
}

/**
 * Update organization name
 */
export async function adminUpdateOrganizationName(
  orgId: number,
  name: string
): Promise<{ success: boolean; message: string; organization: { id: number; name: string } }> {
  return apiPatch({
    path: `/admin/organizations/${orgId}`,
    passedData: { name },
  });
}

/**
 * Update organization subscription tier
 */
export async function adminUpdateOrganizationTier(
  orgId: number,
  tier: "DWY" | "DFY"
): Promise<{ success: boolean; tier: string; message: string }> {
  return apiPatch({
    path: `/admin/organizations/${orgId}/tier`,
    passedData: { tier },
  });
}

/**
 * Delete organization (requires confirmation)
 */
export async function adminDeleteOrganization(orgId: number): Promise<{ success: boolean }> {
  return apiDelete({ path: `/admin/organizations/${orgId}?confirmDelete=true` });
}

/**
 * Get all locations for an organization with their Google Properties
 */
export async function adminGetOrganizationLocations(
  orgId: number
): Promise<AdminLocationsResponse> {
  return apiGet({ path: `/admin/organizations/${orgId}/locations` });
}

/**
 * Create a new organization with an initial admin user
 */
export interface AdminCreateOrgInput {
  organization: {
    name: string;
    domain?: string;
    address?: string;
  };
  user: {
    email: string;
    password: string;
    firstName?: string;
    lastName?: string;
  };
  location: {
    name: string;
    address?: string;
  };
}

export interface AdminCreateOrgResponse {
  success: boolean;
  organizationId: number;
  userId: number;
  locationId: number;
  message: string;
}

export async function adminCreateOrganization(
  input: AdminCreateOrgInput
): Promise<AdminCreateOrgResponse> {
  return apiPost({
    path: "/admin/organizations",
    passedData: input,
  });
}

/**
 * Lock out an organization (sets subscription_status to inactive).
 * Only works for orgs without active Stripe subscription.
 */
export async function adminLockoutOrganization(
  orgId: number
): Promise<{ success: boolean; message: string }> {
  return apiPatch({
    path: `/admin/organizations/${orgId}/lockout`,
    passedData: {},
  });
}

/**
 * Unlock an organization (sets subscription_status back to active).
 */
export async function adminUnlockOrganization(
  orgId: number
): Promise<{ success: boolean; message: string }> {
  return apiPatch({
    path: `/admin/organizations/${orgId}/unlock`,
    passedData: {},
  });
}

/**
 * Create a website project for an organization.
 * Only works if the org doesn't already have a project.
 */
export async function adminCreateProject(
  orgId: number
): Promise<{
  success: boolean;
  message: string;
  project?: { generated_hostname: string; status: string };
}> {
  return apiPost({
    path: `/admin/organizations/${orgId}/create-project`,
    passedData: {},
  });
}

/**
 * Remove payment method from an organization.
 * Cancels the Stripe subscription and clears Stripe IDs.
 * Reverts org to admin-granted state.
 */
export async function adminRemovePaymentMethod(
  orgId: number
): Promise<{ success: boolean; message: string }> {
  return apiPost({
    path: `/admin/organizations/${orgId}/remove-payment-method`,
    passedData: {},
  });
}

/**
 * Start a pilot session as a specific user
 */
export async function adminStartPilotSession(
  userId: number
): Promise<PilotSessionResponse> {
  return apiPost({
    path: `/admin/pilot/${userId}`,
    passedData: {},
  });
}

/**
 * Set a temporary password for a user (admin only)
 */
export interface AdminSetPasswordResponse {
  success: boolean;
  temporaryPassword: string;
  message: string;
}

export async function adminSetUserPassword(
  userId: number,
  notifyUser: boolean
): Promise<AdminSetPasswordResponse> {
  return apiPost({
    path: `/admin/organizations/users/${userId}/set-password`,
    passedData: { notifyUser },
  });
}
